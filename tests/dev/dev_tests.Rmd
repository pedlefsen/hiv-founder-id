---
title: Document Tracking Tests Under Active Development
output: 
  html_document:
    toc: false
    theme: cerulean
---

```{r setup-and-config, include = FALSE}
library(tools)
library(knitr)
pipeline_dir <- '/home/phillipl/projects/hiv-founder-id/code/hiv-founder-id'
knitr::opts_chunk$set(echo = FALSE)
```

## Overview

This document is used to develop tests for the hiv-founder-id pipeline.

The basic testing procedure is:

1) Use a bash chunk to call the pipeline line with a call to perl specifying all the options, including the output directory. Testing output goes in `tests/tmp/test_x` folders
2) Check for the existence of the correct files and folders in `tests/tmp/test_x` against `tests/refs/test_x`.
3) If any files are missing, or if there are extra files, print out the names of the offending files.
4) Ensure that all the files are 'identical' - there might be timestamps etc that need to be ignored.
5) If any files are not identical, print out the names of the files that are not identical.
6) If the primery result file `identify_founders.tab` have mismatches, print out the column names that mismatch, as well as the values in the two files.

**It seems like the commands cannot be run with system from within R, so populate command scripts in the commands folder and then just run them manually**

## The tests

### test_001

```{r, include = FALSE}
c_test_name <- 'test_001'
fasta_file <- 'ld_seqs.fasta'
command_flags <- '-CPRFHT'
test_description <- 'Entropy only on ld_seqs.fasta'
```

```{r, include = FALSE}
conduct_test <- function(c_test_name, fasta_file, command_flags, test_description, pipeline_dir, write_new_command = FALSE){
  c_result <- NULL
  
  ref_folder <- paste(pipeline_dir, '/tests/ref_results',
                      '/', c_test_name, sep = '')
  result_folder <- paste(pipeline_dir, '/tests/tmp',
                         '/', c_test_name, sep = '')
  command_file <- paste(pipeline_dir, '/tests/commands',
                        '/', c_test_name, '.sh', sep = '')
  
  ref_file_names <- list.files(ref_folder)
  result_file_names <- list.files(result_folder)

  command <- paste('cd ', pipeline_dir, '
rm -r tests/tmp/', c_test_name, '
perl identify_founders.pl ', command_flags, ' -o tests/tmp/', c_test_name, ' tests/data/', fasta_file, 
  sep = '')

  if (write_new_command){
    write(command, command_file)
    stop('New command written, now rerun bash scripts')
  }

  file_command <- read.delim(command_file, header = F, stringsAsFactors = FALSE)
  file_command <- paste(file_command[,1], collapse = '\n', sep = '\n')

  commands_match <- command == file_command
  if (!commands_match){
    print(command)
    print('-----')
    print(file_command)
    print('-----')
    return(paste('Commands do not match:
Command 1:
', command, '
-------------
Command 2:
', file_command, '
', sep = ''))
  }

  c_result <- rbind(c_result,
    data.frame(name = 'output_folder_exists',
               result = dir.exists(paste(pipeline_dir, '/tests/tmp/', c_test_name, sep = '')),
               obs = NA_character_,
               expected = NA_character_,
               note = 'We expect the output folder to exists after calling the pipeline',
               stringsAsFactors = FALSE)
    )

  for (c_file in ref_file_names){
    c_result <- rbind(c_result,
      data.frame(name = paste(c_file, '_exists', sep = ''),
                 result = c_file %in% result_file_names,
                 obs = NA_character_,
                 expected = NA_character_,
                 note = 'We expect all the required files to have been created',
                 stringsAsFactors = FALSE)
      )
  }

  for (c_file in ref_file_names){
    ref_md5 <- md5sum(paste(ref_folder, '/', c_file, sep = ''))
    result_md5 <- md5sum(paste(result_folder, '/', c_file, sep = ''))

    names(ref_md5) <- NULL
    names(result_md5) <- NULL

    c_result <- rbind(c_result,
      data.frame(name = paste(c_file, '_matches_ref', sep = ''),
                 result = c_file %in% result_file_names,
                 obs = result_md5,
                 expected = ref_md5,
                 note = 'Produced files are expected to be identical to the reference files',
                 stringsAsFactors = FALSE)
      )
  }

  return(list(test_name = c_test_name,
              fasta_file = fasta_file,
              command_flags = command_flags,
              test_description = test_description,
              command = command,
              test_result = c_result)
  )
}
```

```{r}
test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir)

if (class(test_result) == 'character'){
  for (i in 1:20){
    cat(paste('\n\n', test_result, '\n\n', sep = ''))
  }
} else {
  kable(test_result$test_result)
}
```

```{r, eval = FALSE}

test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir,
               write_new_command = TRUE)

```

