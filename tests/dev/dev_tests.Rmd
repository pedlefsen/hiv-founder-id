---
title: Testing the pipeline
output: 
  html_document:
    toc: false
    theme: cerulean
---

```{r setup-and-config, include = FALSE}
library(tools)
library(knitr)
pipeline_dir <- '/home/phillipl/projects/hiv-founder-id/code/hiv-founder-id'
knitr::opts_chunk$set(echo = FALSE)

source('test_utils.R')
```

## Overview

This document runs and reports on tests for the overall pipeline.

Tests are specified by listing:

* `c_test_name`: The name of the test -> `test_xxx` where xxx is a zero-padded integer.
* `fasta_file`: The name of the input file. This file must exists in the `tests/data` folder
* `command_flags`: The command flags passed to `identify-founders.pl`. Example: -CPR
* `test_description`: A very brief description of the test. Basically just an interpretation of the command flags.

These test specifications live in a csv file called `test_specs.csv` in the tests folder.

There is some weird thing that prevents the pipeline from running correctly when called with a `system` call by `R`. The workaround is to write a bash script into the tests/commands folder that runs the pipeline. These scripts are produced in an automated fashion. If you run the `test_pipeline.R` script in the tests folder with the flag `--build-command-scripts` then these scripts will be produced. There is a `run_all.sh` script in the commands folder that can be used to run all the tests.

2) Check for the existence of the correct files and folders in `tests/tmp/test_x` against `tests/refs/test_x`.
3) If any files are missing, or if there are extra files, print out the names of the offending files.
4) Ensure that all the files are 'identical' - there might be timestamps etc that need to be ignored.
5) If any files are not identical, print out the names of the files that are not identical.
6) If the primery result file `identify_founders.tab` have mismatches, print out the column names that mismatch, as well as the values in the two files.


## The tests

### test_001

```{r, include = FALSE}
c_test_name <- 'test_001'
fasta_file <- 'ld_seqs.fasta'
command_flags <- '-CPRFHT'
test_description <- 'Entropy only on ld_seqs.fasta'
```

```{r}
test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir)

if (class(test_result) == 'character'){
  for (i in 1:20){
    cat(paste('\n\n', test_result, '\n\n', sep = ''))
  }
} else {
  kable(test_result$test_result)
}
```

### test_002

```{r, include = FALSE}
c_test_name <- 'test_002'
fasta_file <- 'ld_seqs.fasta'
command_flags <- '-PRFHT'
test_description <- 'Entropy, PhyML and Insites on ld_seqs.fasta'
```

```{r}
test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir)

if (class(test_result) == 'character'){
  for (i in 1:20){
    cat(paste('\n\n', test_result, '\n\n', sep = ''))
  }
} else {
  kable(test_result$test_result)
}
```





```{r, eval = FALSE}

test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir,
               write_new_command = TRUE)

```

