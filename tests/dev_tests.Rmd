---
title: Testing the hiv-founder-id-pipeline
output: 
  html_document:
    toc: false
    theme: cerulean
---

```{r, echo = FALSE}
if (!exists('pipeline_dir')){
  stop('pipeline_dir variable must be specified')
}
```


```{r setup-and-config, include = FALSE}
library(tools)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)

source('test_utils.R')
```

## Overview

This document runs all the tests for the hiv-founder pipeline and presents the results.

### Specifying tests

Tests are specified by listing:

* `c_test_name`: The name of the test -> `test_xxx` where xxx is a zero-padded integer.
* `fasta_file`: The name of the input file. This file must exists in the `tests/data` folder
* `command_flags`: The command flags passed to `identify-founders.pl`. Example: -CPR
* `test_description`: A very brief description of the test. Basically just an interpretation of the command flags.

These test specifications live in a csv file called `test_specs.csv` in the
tests folder. The last portion of this document also contains these
specifications and the two documents are checked against each other
automatically.

### Running a test

There is some weird thing that prevents the pipeline from running correctly
when called with a `system` call by `R`. The workaround is to write a bash
script into the tests/commands folder that runs the pipeline. These scripts are
produced in an automated fashion. If you run the `test_pipeline.R` script in
the tests folder with the flag `--build-command-scripts` then these scripts
will be produced. There is a `run_all.sh` script in the commands folder that
can be used to run all the tests.

### Steps in performing a test

Using the `run_all.sh` script, the user should run all the command files related to the tests. This will execute all the command scripts in the commands folder, running the pipeline for each test. The output from these runs will be collected in `tests/tmp/test_xxx`. This step cannot be merged into an automated testing approach because the pipeline does not play nice with R's `system` command.

Next, the results produced in the `tests/tmp` folder is checked:

* The existance of the folder `tests/tmp/test_xxx` is checked.
* The dates of the files in this folder are inspected to ensure that the pipeline was run recently.
* A check is performed to ensure that all the files in `tests/ref/test_xxx` are present in `tests/tmp/test_xxx`.
* A check is performed to ensure that all the files in the `ref` and `tmp` are identical using md5 sums.
* The results of all checks are collected into a `data.frame` with the following columns:
  - `name`: The name of the check that was performed
  - `result`: TRUE/FALSE indicating whether or not the check passed
  - `obs`: The observed value related to the check
  - `expected`: The expected calue related to the check
  - `note`: A brief description of the test

### Two modes of testing

Testing can be performed in one of two ways:

* Bulk testing
* Individual testing

Bulk testing loads the test spec file and checks all the tests listed therein.

Individual testing takes a single specification and runs all the checks
associated with that specification producing detailed output for each check.

## Bulk testing

TODO.

## Individual tests

### test_001

```{r, include = FALSE}
c_test_name <- 'test_001'
fasta_file <- 'ld_seqs.fasta'
command_flags <- '-CPRFHT'
test_description <- 'Entropy only on ld_seqs.fasta'
```

```{r}
test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir)

if (class(test_result) == 'character'){
  for (i in 1:20){
    cat(paste('\n\n', test_result, '\n\n', sep = ''))
  }
} else {
  kable(test_result$test_result)
}
```

### test_002

```{r, include = FALSE}
c_test_name <- 'test_002'
fasta_file <- 'ld_seqs.fasta'
command_flags <- '-PRFHT'
test_description <- 'Entropy, PhyML and Insites on ld_seqs.fasta'
```

```{r}
test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir)

if (class(test_result) == 'character'){
  for (i in 1:20){
    cat(paste('\n\n', test_result, '\n\n', sep = ''))
  }
} else {
  kable(test_result$test_result)
}
```

```{r, eval = FALSE}

test_result <-
  conduct_test(c_test_name = c_test_name,
               fasta_file = fasta_file,
               command_flags = command_flags,
               test_description = test_description,
               pipeline_dir = pipeline_dir,
               write_new_command = TRUE)

```

